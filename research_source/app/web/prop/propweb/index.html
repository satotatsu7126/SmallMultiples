<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>prop</title>

</head>
<body>
  prop
  <!--<img src="./map.png">-->
  <div id="shapes"></div>
  <script src="http://d3js.org/d3.v5.min.js"></script>
  <script src ="../../html2canvas.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>s
  <script>

  d3.json("http://localhost:50503/api/prop").then(function(data){
  //結果がデフォルトでdataの_itemsというキーに入る
    onDataLoaded(data["_items"]);
  });
  function onDataLoaded(data) {
    //scaleやdevidecount変えたらcssのbackgroundsizeも変える.devidecountが1増えたらpx2倍,scaleが2倍ならpxも二倍
    console.log(data)
    last="shapes"

    for(var i = 0; i<64; i++){
    console.log(i)
    //i=40
    scale = 125
    devidecount=4
    //グラフを描くエリアよりsvg領域を大きくする
    var w = Math.pow(2,devidecount)*scale+scale*3;
    var h = Math.pow(2,devidecount)*scale;
    var textjoincount = `join`+String(i)
    var textacount='a'+String(i)
    var imagename="cossim"+textjoincount+".png"
    //結合回数をidとしたdiv要素
    var div = $(`<div id="${textjoincount}"></div>`);
    //lastのdiv要素の後にdivをつける
    $(`#${last}`).after(div);
    //自動ダウンロードのための奴
    var a = $(`<a id="${textacount}" download = "${imagename}"></a>`);
    $(`#${textjoincount}`).after(a);
    last = textacount
    var svg = d3.select(`#${textjoincount}`)
      .append("svg")
      .attr("width",w)
      .attr("height",h);
      svg.append("text")
        .attr("x",w-80)
        .attr("y",h/10)
        .text(textjoincount)
        .attr("font-family","sans-serif")
        .attr("font-size","20px")
        .attr("fill","blue")

    joincount = i
    outputdata = data[0]["join"][joincount]["joincount"+String(joincount)]
    drawsq(outputdata,scale,svg)
    drawtext(outputdata,scale,svg)
    drawgraph(outputdata,w,h,scale,svg,devidecount)
    backgroundimage_px=Math.pow(2,devidecount)*scale
    $(`#${textjoincount} #graph .tick text`).css({"font-family":"sans-serif","font-size":"2px"});
    $(`#${textjoincount} .tick line`).css("display","none");
    $(`#${textjoincount} .domain`).css("display","none");
    $(`#${textjoincount}`).css({"background-image":"url('../../rerewhitemap50.jpeg')","background-repeat":"no-repeat","background-size":`${backgroundimage_px}px,${backgroundimage_px}px`});
  }/*
  for(var i = 0; i<64;i++){
    console.log(i)
  var textjoincount = `join`+String(i)
  var textacount='a'+String(i)
  var imagename="cossim"+textjoincount+".png"
    html2canvas(document.querySelector(`#${textjoincount}`)).then(canvas => {
         //document.body.appendChild(canvas)
         canvas.toBlob(function(blob){
           const dataURI = window.URL.createObjectURL(blob);
           const event = document.createEvent("MouseEvents");
           event.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
           const a = document.getElementById(`${textacount}`);
           a.href = dataURI;         // URI化した画像
           a.download = `${imagename}`;    // デフォルトのファイル名
           a.dispatchEvent(event);   // イベント発動
          //sleep(40000);
         })
     });
  }*/
}
    /*
    html2canvas(document.querySelector("#shapes")).then(canvas => {
         document.body.appendChild(canvas)
         var dataURI=canvas.toDataURL();
         var pdf = new jsPDF();
         var width = pdf.internal.pageSize.width;
         pdf.addImage(canvas,'JPEG',0,0,width,0);
         pdf.save("prop"+String(joincount)+".pdf")
     });*/


  function drawsq(data,scale,svg){
    for(var i = 0; i < data.length; i++){
      for(var t = 0; t < data[i]["lineloc"].length; t++){
        if((data[i]["lineloc"][t]["side"])==0){
            svg.append("line")
              //1000かけたり,0.9~で割ってるのは1000×1000の正方形にスケール調整
              //サイトは下に行くほどy軸の値が大きいため,マイナス1をかける必要がある
              .attr("x1", function(d){return data[i]["lineloc"][t]["x0"]*scale})
              .attr("y1", function(d){return -(data[i]["lineloc"][t]["y0"]*scale)})
              .attr("x2", function(d){return data[i]["lineloc"][t]["x0"]*scale})
              .attr("y2", function(d){return -(data[i]["lineloc"][t]["y1"])*scale})
              .attr("stroke","black")
              .attr("stroke-width",2)
              .attr("fill","none");
            }
        else if((data[i]["lineloc"][t]["side"])==1){
            svg.append("line")
              //1000かけたり,0.9~で割ってるのは1000×1000の正方形にスケール調整
              //サイトは下に行くほどy軸の値が大きいため,マイナス1をかける必要がある
              .attr("x1", function(d){return (data[i]["lineloc"][t]["x1"])*scale})
              .attr("y1", function(d){return -(data[i]["lineloc"][t]["y0"])*scale})
              .attr("x2", function(d){return (data[i]["lineloc"][t]["x1"])*scale})
              .attr("y2", function(d){return -(data[i]["lineloc"][t]["y1"])*scale})
              .attr("stroke","black")
              .attr("stroke-width",2)
              .attr("fill","none");
            }
      else if((data[i]["lineloc"][t]["side"])==2){
            svg.append("line")
              //1000かけたり,0.9~で割ってるのは1000×1000の正方形にスケール調整
              //サイトは下に行くほどy軸の値が大きいため,マイナス1をかける必要がある
              .attr("x1", function(d){return (data[i]["lineloc"][t]["x0"])*scale})
              .attr("y1", function(d){return -(data[i]["lineloc"][t]["y1"])*scale})
              .attr("x2", function(d){return (data[i]["lineloc"][t]["x1"])*scale})
              .attr("y2", function(d){return -(data[i]["lineloc"][t]["y1"])*scale})
              .attr("stroke","black")
              .attr("stroke-width",2)
              .attr("fill","none");
            }
      else if((data[i]["lineloc"][t]["side"])==3){
            svg.append("line")
              //1000かけたり,0.9~で割ってるのは1000×1000の正方形にスケール調整
              //サイトは下に行くほどy軸の値が大きいため,マイナス1をかける必要がある
              .attr("x1", function(d){return (data[i]["lineloc"][t]["x0"])*scale})
              .attr("y1", function(d){return -(data[i]["lineloc"][t]["y0"])*scale})
              .attr("x2", function(d){return (data[i]["lineloc"][t]["x1"])*scale})
              .attr("y2", function(d){return -(data[i]["lineloc"][t]["y0"])*scale})
              .attr("stroke","black")
              .attr("stroke-width",2)
              .attr("fill","none");
            }
        }
      }
    }
  function drawtext(data,scale,svg){
//四角の番号表記
    for(var i = 0; i < data.length; i++){
      var x = (data[i]["gx0"])*scale+3
      var y = -(data[i]["gy1"])*scale+30
      var t = String(i)
      svg.append("text")
        .attr("x",x)
        .attr("y",y)
        .text(t)
        .attr("font-family","sans-serif")
        .attr("font-size","20px")
        .attr("fill","red")
      }
    }

  function drawgraph(data,w,h,scale,svg){
        //y1<y0
        //y軸のスケールyscとx軸の長さxwidthを決める
    var minxwidth = w
    totaltq = 0
    ysc = 0
    for(var q = 0; q < data.length; q++){
      var sy0 = -(data[q]["gy0"])*scale
      var sy1 = -(data[q]["gy1"])*scale
      var sx0 = (data[q]["gx0"])*scale
      var sx1 = (data[q]["gx1"])*scale
      mkeys=d3.keys(data[q]["devidetweets"]["month"])
      dpool=d3.keys(data[q]["devidetweets"]["month"][mkeys]) //"day"が作られているかどうか
      if(dpool=="day"){
        dnumbers=d3.keys(data[q]["devidetweets"]["month"][mkeys]["day"]); //"d1"など
        //mkgraph = {};
        dataset1 = []
        for(var t = 0; t < dnumbers.length; t++){
          //mkgraph[dnumbers[t]]=data[i]["devidetweets"]["month"][mkeys]["day"][dnumbers[t]][quantities];
          var tweetsnumber = data[q]["devidetweets"]["month"][mkeys]["day"][dnumbers[t]]
          tweetskeys=d3.keys(tweetsnumber)
          //tweet数tq
          tq=tweetsnumber[tweetskeys]
          if(ysc<(tq/(sy0-sy1))){
            ysc=(tq/(sy0-sy1))
            }
              //以下のif文検討の余地あり
          if(minxwidth>(sx1-sx0)){
            minxwidth=sx1-sx0
          }
        }
        //ysc,minxwidth終了
      }
      //分割領域全部参照
    }
    //グラフを描くx軸
    for(var i = 0; i<data.length;i++){
      //棒グラフを表示させるデータがあるかどうかの変数tqc
      tqc = 0
      dataset = []
      mkeys=d3.keys(data[i]["devidetweets"]["month"])
      if(dpool=="day"){
          dnumbers=d3.keys(data[i]["devidetweets"]["month"][mkeys]["day"]); //"d1"など
          //mkgraph = {};
          dataset1 = []
          for(var t = 0; t < dnumbers.length; t++){
            //mkgraph[dnumbers[t]]=data[i]["devidetweets"]["month"][mkeys]["day"][dnumbers[t]][quantities];
            var tweetsnumber = data[i]["devidetweets"]["month"][mkeys]["day"][dnumbers[t]]
            tweetskeys=d3.keys(tweetsnumber)
            //tweet数tq
            tq=tweetsnumber[tweetskeys]
            totaltq = totaltq+tq
            if(tq != 0){
              tqc = 1
            }
            d = {}
            monday = 16
            d["day"]=dnumbers[t]
            d["value"]=tq
            if((dnumbers[t]=="d"+String(monday)) || (dnumbers[t]=="d"+String(monday+5)) || (dnumbers[t]=="d"+String(monday+6)) || (dnumbers[t]=="d"+String(monday+12)) || (dnumbers[t]=="d"+String(monday+13))){
              d["color"] = "red"
            } else{
              d["color"] = "steelblue"
            }
              dataset1.push(d);
          }
          //一日でもツイートがあれば
          if(tqc == 1){
            dataset = dataset1
          }
        }
        var gx0 = (data[i]["gx0"])*scale
        var gx1 = (data[i]["gx1"])*scale
        var gy0 = -(data[i]["gy0"])*scale
        var gy1 = -(data[i]["gy1"])*scale
        var xlpadding = 3
        var xrpadding = 1
        var yupadding = 3
        var ydpadding = 1
        var xScale = d3.scaleBand()
          .rangeRound([(gx0+gx1)/2-minxwidth/2+xlpadding, (gx0+gx1)/2+minxwidth/2- xrpadding]) //x軸の範囲
          .padding(0.3) //棒グラフのバーとバーの間
          .domain(dataset.map(function(d) { return d.day; }));

        //(ysc*scale)/10は，yscを決めている分割領域の頭がぶつからないための余白
        var yScale = d3.scaleLinear()
          .domain([0, (ysc*(gy0-gy1)+(ysc*scale)/10)])//d3.max(dataset, function(d) { return d.value; })])
          .range([gy0, gy1]);

        var xAxis = d3.axisBottom(xScale).tickSizeInner(0);
        var yAxis = d3.axisLeft(yScale).tickSizeInner(0);

        // 4. 軸の表示
        svg.append("g")
          .attr("id", "graph")
          .attr("transform", "translate(" + 0 + "," + (gy0 - ydpadding) + ")")
          .call(xAxis);

        svg.append("g")
          .attr("id","graph")
          .attr("transform", "translate(" + (gx0 + xlpadding) + "," + 0 + ")")
          .call(yAxis);

        // 5. バーの表示
        svg.append("g")
          .selectAll("rect")
          .data(dataset)
          .enter()
          .append("rect")
          .attr("x", function(d) { return xScale(d.day); })
          .attr("y", function(d) { return yScale(d.value); })
          .attr("width", xScale.bandwidth())
          .attr("height", function(d) { return gy0 - yScale(d.value); })
          .attr("fill", function(d){return d.color});
      }
      legend_d={}
      dataset2=[]
      for(var t = 0; t < dnumbers.length; t++){
        legend_d["day"]=dnumbers[t];
      }

      dataset2.push(legend_d);
      var gx0 = Math.pow(2,devidecount)*scale+scale
      var gx1 = Math.pow(2,devidecount)*scale+2*scale
      var gy0 = Math.pow(2,devidecount)*scale
      var gy1 = Math.pow(2,devidecount)*scale-scale

      var xScale = d3.scaleBand()
        .rangeRound([(gx0+gx1)/2-minxwidth/2+xlpadding, (gx0+gx1)/2+minxwidth/2- xrpadding]) //x軸の範囲
        .padding(0.3) //棒グラフのバーとバーの間
        .domain(dataset.map(function(d) { return d.day; }));

      var yScale = d3.scaleLinear()
        .domain([0, ysc*(gy0-gy1)])//d3.max(dataset, function(d) { return d.value; })])
        .range([gy0, gy1]);

      var xAxis = d3.axisBottom(xScale).tickSizeInner(0);
      var yAxis = d3.axisLeft(yScale).tickSizeInner(0);

      // 4. 軸の文字の表示
      svg.append("g")
        .attr("id","example")
        .attr("transform", "translate(" + 0 + "," + (gy0 - ydpadding) + ")")
        .call(xAxis);

      //svg.append("g")
        //.attr("id","example")
        //.attr("transform", "translate(" + (gx0 + xlpadding) + "," + 0 + ")")
        //.call(yAxis);
      svg.append("rect")
          .attr("x",gx0)
          .attr("y",gy1)
          .attr("width",scale)
          .attr("height",scale)
          .attr("stroke","black")
          .attr("stroke-width",2)
          .attr("fill","none");

      svg.append("text")
          .attr("x",gx0)
          .attr("y",gy1+15)
          .text(String(parseInt(ysc*(scale-ydpadding))))
          .attr("font-family","sans-serif")
          .attr("font-size","15px")
          .attr("fill","black")

      svg.append("text")
          .attr("x",gx0)
          .attr("y",gy1+15+scale*1/3)
          .text(String(parseInt(ysc*(scale-ydpadding)*2/3)))
          .attr("font-family","sans-serif")
          .attr("font-size","15px")
          .attr("fill","black")

      svg.append("text")
          .attr("x",gx0)
          .attr("y",gy1+15+scale*2/3)
          .text(String(parseInt(ysc*(scale-ydpadding)/3)))
          .attr("font-family","sans-serif")
          .attr("font-size","15px")
          .attr("fill","black")
    }
  </script>
</body>
</html>
