<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>fix-devide88</title>
  <link rel="stylesheet" type="text/css" href="./css/stylesheet.css">
  <!--
  <style>
 #shape1 .tick text{
    font-family: sans-serif;
    font-size: 3px;
}
#shape1 .tick line{
  display: none;
}
#shape1 .domain{
  display: none;
}
</style>
-->
</head>
<body>
  fix-devide88
  <!--<img src="./map.png">-->
  <div id="shape1"></div>
  <script src="http://d3js.org/d3.v5.min.js"></script>
  <script>

  d3.json("http://localhost:50503/api/fix88").then(function(data){
  //結果がデフォルトでdataの_itemsというキーに入る
    onDataLoaded(data["_items"]);
    //console.log(data);
  });

  function onDataLoaded(data) {
    //console.log(JSON.stringify(data[0]["x1"], null, 2));
    //drawMap(data);
    //drawBarChart(data);
    //drawLineChart(data);
    drawFourDivided(data)
  }

  function drawFourDivided(data){
    //data1=d3.keys(data);
    //console.log(JSON.stringify(d3.keys(data),null,2));
    count = 0
    var w = 2000;
    var h = 2000;
    var svg = d3.select("#shape1").append("svg")
    .attr("width",w)
    .attr("height",h);

/*
    var group1 = svg.selectAll(".group1")
      .data(data)
      .enter()
      .append("g");

    var rect = group1.append("rect")
      .attr("class","rect1")
      .attr("x",function(d,i){return (data[i]["x0"]-139.653911)*1000/0.117317})
      .attr("y",function(d,i){return (35.737841-35.737841)*1000/0.112026-(data[i]["y1"]-35.737841)*1000/0.112026})
      .attr("height",function(d,i){return data[i]["height"]*1000/0.112026})
      .attr("stroke","black")
      .attr("stroke-width",0.5)
      .attr("fill","red");
      var text1 = svg.append("text")
  			.attr('class','text1')
  			.attr("x", function(d,i){return (data[i]["x0"]-139.653911)*1000/0.117317}+30)
  			.attr("y", function(d,i){return (35.737841-35.737841)*1000/0.112026-(data[i]["y1"]-35.737841)*1000/0.112026}+30)
        .attr("font-size","20px")
  			;
        */

      //四角の数(i)だけループ
    for(var i = 0; i < data.length; i++){
      console.log(data.length)
      x0 = 139.668636
      x1 = 139.798017
      y0 = 35.607243
      y1 = 35.736624
      disx=x1-x0
      disy=y1-y0
      scale = 1000
      //どの四角に含まれているか調べたい座標searchx,searchy

      //console.log(disx/data.length)
      //console.log(disy/data.length)

      svg.append("rect")
        //1000かけたり,0.9~で割ってるのは1000×1000の正方形にスケール調整
        //サイトは下に行くほどy軸の値が大きいため,(35.737841-35.737841)*1000/0.112026をする必要がある
        //練馬駅:東経139.653911 北緯35.737841
        //台場駅:東経139.771228 北緯35.625815

        //0.117317はデータの経度の差
        //0.112026はデータの緯度の差
        .attr("x",function(d){return (data[i]["x0"]-x0)*scale/disx})
        .attr("y",function(d){return (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy})
        .attr("width",function(d){return data[i]["width"]*scale/disx})
        .attr("height",function(d){return data[i]["height"]*scale/disy})
        .attr("stroke","black")
        .attr("stroke-width",0.5)
        .attr("fill","none");
        //渋谷を赤に
        /*
      searchx = 139.701694
      searchy = 35.658250
      if( (Math.abs(searchx-data[i]["x0"])<(data[i]["width"])) && (Math.abs(searchx-data[i]["x1"])<(data[i]["width"]))) {
        if( (Math.abs(searchy-data[i]["y0"])<(data[i]["height"])) && (Math.abs(searchy-data[i]["y1"])<(data[i]["height"]))){
          svg.append("rect")
            .attr("x",function(d){return (data[i]["x0"]-x0)*scale/disx})
            .attr("y",function(d){return (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy})
            .attr("width",function(d){return data[i]["width"]*scale/disx})
            .attr("height",function(d){return data[i]["height"]*scale/disy})
            .attr("stroke","red")
            .attr("stroke-width",2)
            .attr("fill","none");
              }
            }
        //新宿を黄色に
          searchx = 139.700360
          searchy = 35.689820
          if( (Math.abs(searchx-data[i]["x0"])<(data[i]["width"])) && (Math.abs(searchx-data[i]["x1"])<(data[i]["width"]))) {
            if( (Math.abs(searchy-data[i]["y0"])<(data[i]["height"])) && (Math.abs(searchy-data[i]["y1"])<(data[i]["height"]))){
              svg.append("rect")
                .attr("x",function(d){return (data[i]["x0"]-x0)*scale/disx})
                .attr("y",function(d){return (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy})
                .attr("width",function(d){return data[i]["width"]*scale/disx})
                .attr("height",function(d){return data[i]["height"]*scale/disy})
                .attr("stroke","yellow")
                .attr("stroke-width",2)
                .attr("fill","none");
                  }
                }
        //東京を緑色に
        searchx = 139.767444
        searchy = 35.681384
        if( (Math.abs(searchx-data[i]["x0"])<(data[i]["width"])) && (Math.abs(searchx-data[i]["x1"])<(data[i]["width"]))) {
          if( (Math.abs(searchy-data[i]["y0"])<(data[i]["height"])) && (Math.abs(searchy-data[i]["y1"])<(data[i]["height"]))){
            svg.append("rect")
              .attr("x",function(d){return (data[i]["x0"]-x0)*scale/disx})
              .attr("y",function(d){return (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy})
              .attr("width",function(d){return data[i]["width"]*scale/disx})
              .attr("height",function(d){return data[i]["height"]*scale/disy})
              .attr("stroke","green")
              .attr("stroke-width",3)
              .attr("fill","none");
                }
              }
        //秋葉を紫に
        searchx = 139.773071
        searchy = 35.698449
        if( (Math.abs(searchx-data[i]["x0"])<(data[i]["width"])) && (Math.abs(searchx-data[i]["x1"])<(data[i]["width"]))) {
            if( (Math.abs(searchy-data[i]["y0"])<(data[i]["height"])) && (Math.abs(searchy-data[i]["y1"])<(data[i]["height"]))){
              svg.append("rect")
                .attr("x",function(d){return (data[i]["x0"]-x0)*scale/disx})
                .attr("y",function(d){return (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy})
                .attr("width",function(d){return data[i]["width"]*scale/disx})
                .attr("height",function(d){return data[i]["height"]*scale/disy})
                .attr("stroke","purple")
                .attr("stroke-width",2)
                .attr("fill","none");
                  }
                }

        //品川を青に
        searchx = 139.738664
        searchy = 35.628415
        if( (Math.abs(searchx-data[i]["x0"])<(data[i]["width"])) && (Math.abs(searchx-data[i]["x1"])<(data[i]["width"]))) {
            if( (Math.abs(searchy-data[i]["y0"])<(data[i]["height"])) && (Math.abs(searchy-data[i]["y1"])<(data[i]["height"]))){
                svg.append("rect")
                  .attr("x",function(d){return (data[i]["x0"]-x0)*scale/disx})
                  .attr("y",function(d){return (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy})
                  .attr("width",function(d){return data[i]["width"]*scale/disx})
                  .attr("height",function(d){return data[i]["height"]*scale/disy})
                  .attr("stroke","blue")
                  .attr("stroke-width",2)
                  .attr("fill","none");
                  }
                }
                        */
      var x = (data[i]["x0"]-x0)*scale/disx+3
      var y = (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy+10
      var t = data[i]["sqnumber"]
      svg.append("text")
        .attr("x",x)
        .attr("y",y)
        .text(t)
        .attr("font-family","sans-serif")
        .attr("font-size","5px")
        .attr("fill","red")


      //グラフ描く

      mkeys=d3.keys(data[i]["devidetweets"]["month"]) //"m8"
      dpool=d3.keys(data[i]["devidetweets"]["month"][mkeys]) //"day"が作られているかどうか

      tqc = 0
      dataset = []
      if(dpool=="day"){
        dnumbers=d3.keys(data[i]["devidetweets"]["month"][mkeys]["day"]); //"d1"など
        //mkgraph = {};
        dataset1 = []
        for(var t = 0; t < dnumbers.length; t++){
          //mkgraph[dnumbers[t]]=data[i]["devidetweets"]["month"][mkeys]["day"][dnumbers[t]][quantities];
          var tweetsnumber = data[i]["devidetweets"]["month"][mkeys]["day"][dnumbers[t]]
          tweetskeys=d3.keys(tweetsnumber)

          //tweet数
          tq=tweetsnumber[tweetskeys].length
          if(tq != 0){
            tqc = 1
          }
          //console.log(tweetsnumber[tweetskey]);
          d = {}
          monday = 16
          d["day"]=dnumbers[t]
          d["value"]=tq
          if((dnumbers[t]=="d"+String(monday)) || (dnumbers[t]=="d"+String(monday+5)) || (dnumbers[t]=="d"+String(monday+6)) || (dnumbers[t]=="d"+String(monday+12)) || (dnumbers[t]=="d"+String(monday+13))){
            d["color"] = "red"
          } else{
            d["color"] = "steelblue"
          }
          count = count + tq
            dataset1.push(d);
        }
        if(tqc == 1){
          dataset = dataset1
        }
        //console.log(data)
        // 3. 軸スケールの設定
        var gx0 = (data[i]["x0"]-x0)*scale/disx
        var gx1 = (data[i]["x1"]-x0)*scale/disx
        var gy0 = (y1-y1)*scale/disy-(data[i]["y0"]-y1)*scale/disy
        var gy1 = (y1-y1)*scale/disy-(data[i]["y1"]-y1)*scale/disy
        var xlpadding = 7
        var xrpadding = 2
        var yupadding = 7
        var ydpadding = 2
        //console.log(y1)
        //console.log("a")
        //console.log(y0)
        //y1<y0

        var xScale = d3.scaleBand()
          .rangeRound([gx0+xlpadding, gx1- xrpadding]) //x軸の範囲
          .padding(0.3) //棒グラフのバーとバーの間
          .domain(dataset.map(function(d) { return d.day; }));

        var yScale = d3.scaleLinear()
          .domain([0, 2500])//d3.max(dataset, function(d) { return d.value; })])
          .range([gy0 - ydpadding, gy1+yupadding]);

        var xAxis = d3.axisBottom(xScale).tickSizeInner(0);
        var yAxis = d3.axisLeft(yScale).tickSizeInner(0);

        // 4. 軸の表示
        svg.append("g")
          .attr("transform", "translate(" + 0 + "," + (gy0 - ydpadding) + ")")
          .call(xAxis);

        svg.append("g")
          .attr("transform", "translate(" + (gx0 + xlpadding) + "," + 0 + ")")
          .call(yAxis);

        // 5. バーの表示
        svg.append("g")
          .selectAll("rect")
          .data(dataset)
          .enter()
          .append("rect")
          .attr("x", function(d) { return xScale(d.day); })
          .attr("y", function(d) { return yScale(d.value); })
          .attr("width", xScale.bandwidth())
          .attr("height", function(d) { return gy0 - ydpadding - yScale(d.value); })
          .attr("fill", function(d){return d.color});
        //console.log(dataset)
      }

    //console.log(JSON.stringify(data[3]["tweets"][0]["lon"],null,2));
    }
  //console.log(data.length)
  console.log(count)
  }

  </script>
</body>
</html>
